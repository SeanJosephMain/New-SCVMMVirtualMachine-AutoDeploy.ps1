# New-SCVMMVirtualMachine-AutoDeploy.ps1
This PowerShell script automates end-to-end virtual machine provisioning in a System Center Virtual Machine Manager (SCVMM) environment while avoiding hardcoded sensitive data. At the top, it centralizes all environment-specific values (VMM server name, network names, CSV/ClusterStorage filters, library/unattend path, Slack webhook, and known template/OS IDs) into variables, so the main logic never exposes real file paths, GUIDs, or webhook URLs. The script first imports the VMM module and runs a cluster health check: it enumerates SCVMM clusters that match a name pattern  and, if any are overcommitted, it logs the issue and optionally posts a message to a Slack webhook, then stops to prevent deploying to an unhealthy cluster.

Before creating a new VM, it performs a “cleanup” step. It looks for a small text file (its location is also configurable) that stores the names of the last temporary VM template and hardware profile created on the previous run. If found, it rehydrates those names, deletes the corresponding objects from SCVMM, and archives the cleanup file to a timestamped location. This keeps the VMM library clean from build-time artifacts.

Next, the script builds the VM definition dynamically. It creates a new hardware profile with the CPU count, memory, secure boot, and generation 2 settings that were passed in, and it clones from a known base VM template and operating system. It also pins the VM to a specific VM network and IP pool, again using variables defined at the top instead of hardcoded values.

For storage placement, the script scans all SCVMM hosts that match the filter, gathers their ClusterStorage volumes, counts how many VMs are on each, and collects free space. With that, it classifies volumes (usable, full, overcommitted, or low on space) based on configurable thresholds, and picks the best candidate. Finally, it creates the VM on the most available host, pins the VM location to the chosen CSV, writes a fresh cleanup file for the next run, and logs/sends a success or failure notification.
